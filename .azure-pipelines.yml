jobs:
- job: build
  pool:
    vmImage: 'macOS-10.15'
  timeoutInMinutes: 300
  strategy:
    maxParallel: 4
    matrix: 
      windows_7:
        template: windows_7
      windows_10:
        template: windows_10
      windows_server_2019_core:
        template: windows_2019_core
  steps:
  - bash: |
      wget -nv -nc -O packer_1.6.0_darwin_amd64.zip https://releases.hashicorp.com/packer/1.6.0/packer_1.6.0_darwin_amd64.zip
      sudo unzip -o packer_1.6.0_darwin_amd64.zip -d /usr/local/bin
    displayName: Install Packer
  - bash: |
      pip install --user ansible
      pip install pywinrm
      ln -s /Users/runner/Library/Python/2.7/bin/ansible /usr/local/bin/ansible
      ln -s /Users/runner/Library/Python/2.7/bin/ansible-playbook /usr/local/bin/ansible-playbook
    displayName: Install Ansible
  - bash: |
      packer --version
      ansible --version
      ansible-playbook --version
      vboxmanage --version
      sysctl -a | grep machdep.cpu
      sysctl -a | grep mem
      df -h .
    displayName: Dump software version
  - bash: |
      wget -nv -nc https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso -O $(Agent.BuildDirectory)/virtio-win.iso
    displayName: Download virtio-win iso
  - bash: |
      # Set PACKER_LOG to 1 to troubleshoot infrastructure issues
      # export PACKER_LOG=1
      export PACKER_CACHE_DIR=$(Agent.BuildDirectory)/packer_cache/
      # See https://github.com/ansible/ansible/issues/49207
      # See https://github.com/ansible/ansible/issues/32499
      export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
      packer build --only=virtualbox-iso --var virtio_win_iso=$(Agent.BuildDirectory)/virtio-win.iso --var memory=6144 $(template).json
    displayName: Build box
  - bash: |
      shasum -a 256 $(template)_virtualbox.box
      az storage blob upload --auth-mode=key --account-name=$(AZURE_STORAGE_ACCOUNT) --account-key=$(AZURE_STORAGE_KEY) --container-name boxes --file $(template)_virtualbox.box --name $(Build.BuildNumber)/$(template)_virtualbox.box

      echo "The box has been uploaded to Azure Storage:"
      echo "URL: https://$(AZURE_STORAGE_ACCOUNT).blob.core.windows.net/boxes/$(Build.BuildNumber)/$(template)_virtualbox.box"
      echo "SHA256: `shasum -a 256 $(template)_virtualbox.box`"
    displayName: Upload box to Azure Storage
    # Don't waste too much time uploading artifacts on slow connections
    timeoutInMinutes: 30