sudo: true
language: minimal
dist: bionic

jobs:
    include:
    - env: PROVIDER=qemu TEMPLATE=windows_7 VIRT_GROUP=kvm
    - env: PROVIDER=qemu TEMPLATE=windows_10 VIRT_GROUP=kvm
    - env: PROVIDER=qemu TEMPLATE=windows_2019_docker VIRT_GROUP=kvm
    - env: PROVIDER=qemu TEMPLATE=windows_server_2004 VIRT_GROUP=kvm

install:
# Install Packer. Travis ships with Packer 1.3, which is fairly old
- wget -nv -nc -O packer_1.6.0_linux_amd64.zip https://releases.hashicorp.com/packer/1.6.0/packer_1.6.0_linux_amd64.zip
- sudo unzip -o packer_1.6.0_linux_amd64.zip -d /usr/local/bin

# Install ansible
- sudo add-apt-repository -y ppa:ansible/ansible
- sudo apt-get update
- sudo apt-get install -yq --no-install-suggests --no-install-recommends ansible
- pip install pywinrm

# Install qemu-kvm
- if [ $PROVIDER == "qemu" ]; then sudo apt-get install -yq --no-install-suggests --no-install-recommends qemu-kvm qemu-utils; fi

# Install Azure CLI
- AZ_REPO=$(lsb_release -cs) && echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main" | sudo tee /etc/apt/sources.list.d/azure-cli.list
- curl -L https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
- sudo apt-get install apt-transport-https
- sudo apt-get update && sudo apt-get install -yq --no-install-suggests --no-install-recommends azure-cli

# Set up group membership
- sudo adduser $USER $VIRT_GROUP

# Dump versions of available software
- lsb_release -a
- uname -r
- if [ $PROVIDER == "qemu" ]; then qemu-system-x86_64 --version; fi
- packer --version
- ansible --version

# Dump group membership
- groups
- sudo sudo -u $USER -g $VIRT_GROUP groups
- sudo -E su $USER -c 'groups'

# Dump CPU information
- cat /proc/cpuinfo

# Dump available disk space
- lsblk -e7
- df -h .

script:
# Ping stdout every 9 minutes to prevent Travis from terminating the buidl.
- |
  while sleep 9m; do
    echo "====[ This job has been running for $SECONDS ]===="
  done &
# Download the virtio-win iso
- wget -nv -nc https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso -O ~/virtio-win.iso
# See here https://github.com/travis-ci/travis-ci/issues/1839 for background on the sudo sudo command
- sudo -E su $USER -c 'packer build --only=${PROVIDER} --var disk_size=30720 --var virtio_win_iso=~/virtio-win.iso --var memory=6144 ${TEMPLATE}.json'
# Upload the resulting box to Azure Storage
- sha256sum $(template)_libvirt.box
- az storage blob upload --auth-mode=key --account-name=${AZURE_STORAGE_ACCOUNT} --account-key=${AZURE_STORAGE_KEY} --container-name boxes --file ${TEMPLATE}_libvirt.box --name ${TRAVIS_JOB_ID}/${TEMPLATE}_libvirt.box