sudo: true
language: bash
dist: bionic

jobs:
    include:
    - env: PROVIDER=qemu TEMPLATE=windows_10 VIRT_GROUP=kvm
    # - env: PROVIDER=virtualbox-iso TEMPLATE=windows_10 VIRT_GROUP=vboxusers

    - env: PROVIDER=qemu TEMPLATE=windows_7 VIRT_GROUP=kvm
    # - env: PROVIDER=virtualbox-iso TEMPLATE=windows_7 VIRT_GROUP=vboxusers

install:
# Install Packer. Travis ships with Packer 1.3, which is fairly old
- wget -nv -nc -O packer_1.6.0_linux_amd64.zip https://releases.hashicorp.com/packer/1.6.0/packer_1.6.0_linux_amd64.zip
- sudo unzip -o packer_1.6.0_linux_amd64.zip -d /usr/local/bin

# Install ansible
- sudo add-apt-repository -y ppa:ansible/ansible
- sudo apt-get update
- sudo apt-get install -yq --no-install-suggests --no-install-recommends ansible

# Install qemu-kvm
- if [ $PROVIDER == "qemu" ]; then sudo apt-get install -yq --no-install-suggests --no-install-recommends qemu-kvm qemu-utils; fi

# Install VirtualBox
- if [ $PROVIDER == "virtualbox-iso" ]; then wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -; fi
- if [ $PROVIDER == "virtualbox-iso" ]; then echo 'deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian bionic contrib' | sudo tee -a /etc/apt/sources.list; fi
- if [ $PROVIDER == "virtualbox-iso" ]; then sudo apt-get update; fi
- if [ $PROVIDER == "virtualbox-iso" ]; then sudo apt-get install -y linux-headers-$(uname -r); fi
- if [ $PROVIDER == "virtualbox-iso" ]; then sudo apt-get install -y virtualbox-6.1; fi

# Set up group membership
- sudo adduser $USER $VIRT_GROUP

# Dump versions of available software
- lsb_release -a
- uname -r
- if [ $PROVIDER == "qemu" ]; then qemu-system-x86_64 --version; fi
- if [ $PROVIDER == "virtualbox-iso" ]; then vboxmanage --version; fi
- packer --version
- ansible --version

# Dump group membership
- groups
- sudo sudo -u $USER -g $VIRT_GROUP groups
- sudo -E su $USER -c 'groups'

# Dump CPU information
- cat /proc/cpuinfo

script:
# Download the virtio-win iso
- wget -nv -nc https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso -O ~/virtio-win.iso
- export PACKER_LOG=1
# See here https://github.com/travis-ci/travis-ci/issues/1839 for background on the sudo sudo command
- sudo -E su $USER -c 'packer build --only=${PROVIDER} --var virtio_win_iso=~/virtio-win.iso ${TEMPLATE}.json'